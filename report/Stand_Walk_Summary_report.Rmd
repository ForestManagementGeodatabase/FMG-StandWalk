---
title: "FMG Stand Summary"
output:
  html_document:
    css: style_1.css
params:
  stand_id:                         # string
  age_fixed_summary:                # data frame
  stand_summary:                    # data frame
  species_summary:                  # data frame
  health_summary:                   # data frame
  imp_stand_summary:                # data frame
  imp_plot_summary:                 # data frame
---

```{r get_data, echo=FALSE}
report_version <- "0.1.1"

library(dplyr)

# Get the species-mast type table
fmg_dir <- ".."
fmg_data <- file.path(fmg_dir, "data")
spp_masttype_file <- file.path(fmg_data, "SppMastType.csv")
spp_masttype <- read.csv(spp_masttype_file)
```

```{r test_data, echo=FALSE}
# For testing (cannot use the variable name `params` as it is controlled by the IDE)
# params <- list("stand_id" = stand_id,
#                 "age_fixed_summary" = age_fixed_summary,
#                 "stand_summary" = stand_summary,
#                 'species_summary' = species_summary,
#                 "health_summary" = health_summary,
#                 "imp_stand_summary" = imp_stand_summary,
#                 "imp_plot_summary" = imp_plot_summary)
```


```{r select_stand, echo=FALSE}
# Filter for the current stand
age_fixed_st <- dplyr::filter(params$age_fixed_summary, 
                              SITE_NEW == params$stand_id)
stand_st     <- dplyr::filter(params$stand_summary, 
                              SITE_NEW == params$stand_id)
species_st   <- dplyr::filter(params$species_summary, 
                              SITE_NEW == params$stand_id)
health_st    <- dplyr::filter(params$health_summary, 
                              SITE_NEW == params$stand_id)
```

```{r sort_tables, echo=FALSE}
# Sort tables
species_sort <- dplyr::arrange(species_st, desc(AV_BA), desc(AV_TPA), desc(QM_DBH))
health_sort <- dplyr::arrange(health_st, desc(AV_TPA))
```

```{r set_factors, echo=FALSE}
# Set health_summary$TR_HLTH labels
health_sort$TR_HLTH <- factor(health_sort$TR_HLTH,
                              levels = c("V", "S", "SD", "D"),
                              labels = c("Healthy-Vigorous", "Stressed", 
                                         "Significant Decline", "Dead"))
```

```{r hard_mast, echo=FALSE}
# Calculate hard mast stats
## Get list of hard mast species
hard_mast_spp <- dplyr::filter(spp_masttype, MAST_TYPE == "HARD")

## Filter species_st for only hard mast species
species_hard_mast <- dplyr::filter(species_st, TR_SP %in% hard_mast_spp$TR_SP)

# Calculate hard mast QM_DBH
hard_mast_BA_TPA <- (sum(species_hard_mast$AV_BA)/sum(species_hard_mast$AV_TPA))
hard_mast_QM_DBH <- sqrt(hard_mast_BA_TPA/0.005454154)

# Count of hard mast species
hard_mast_spp_count <- length(species_hard_mast$TR_SP)
```


```{r species_richness, echo=FALSE}
# Calculate species richness
## Typical Species
## Get list of 'typical' species
typical_spp <- dplyr::filter(spp_masttype, TYPICAL == "COMMON")

## Filter species_st for only 'typical' species
species_typical <- dplyr::filter(species_st, TR_SP %in% typical_spp$TR_SP)

## Count 'typical' species
typical_spp_count <- length(species_typical$TR_SP)

## Other Species
## Get list of 'other' species
other_spp <- dplyr::filter(spp_masttype, MAST_TYPE != "HARD",
                                         TYPICAL != "COMMON")
## Filter species_st for only 'other' species
species_other <- dplyr::filter(species_st, TR_SP %in% other_spp$TR_SP)

## Count 'typical' species
other_spp_count <- length(species_other$TR_SP)

## Create "Species Richness" string
species_richness <- paste0(hard_mast_spp_count, other_spp_count, typical_spp_count)
```


```{r set_variables, echo=FALSE}
# collector
forester <- ""
date <- ""

# stand_id
pool           <- substr(stand_st$SITE_NEW, 1, 3)
compartment    <- substr(stand_st$SITE_NEW, 4, 7)
unit           <- substr(stand_st$SITE_NEW, 8, 11)
site           <- substr(stand_st$SITE_NEW, 12, 15)
stand          <- substr(stand_st$SITE_NEW, 16, 19)
num_plots      <- stand_st$NUM_PL
num_age_plots  <- NA
walk_acres     <- NA                      # unclear what area being referenced
inventory_year <- NA                      # age_fixed_summary? string of years?
dom_soil_type  <- NA                      # new tool?

# stand-summary-data
tpa              <- floor(stand_st$AV_TPA)
basal_area       <- floor(stand_st$AV_BA)
qm_dbh           <- paste0(floor(stand_st$QM_DBH), '"')
stocking         <- NA                    # where should this live? stand?
canopy_height    <- paste0(round(age_fixed_st$OV_HT/5)*5, "'")    # nearest 5 ft
canopy_closure   <- paste0(round(age_fixed_st$OV_CLSR, -1), "%")  # nearest 10 %
hard_mast_tpa    <- floor(sum(species_hard_mast$AV_TPA))
hard_mast_ba     <- floor(sum(species_hard_mast$AV_BA))
hard_mast_qm_dbh <- paste0(floor(hard_mast_QM_DBH), '"')
hard_mast_stock  <- NA                    
under_height     <- paste0(round(age_fixed_st$UND_HT, 2), "'")
snag_tpa         <- floor(stand_st$SNAG_TPA)
stand_age        <- floor(age_fixed_st$TR_AGE)
hard_mast_age    <- NA                    
growth           <- NA                    # where should this live?
stand_health     <- health_sort[1,]$TR_HLTH
species_rich     <- species_richness
regen_rate       <- floor(age_fixed_st$UND_COV)

# Size Class Distribution (TPA)
polesize         <- floor(stand_st$POL_TPA)
sawtimber        <- floor(stand_st$SAW_TPA)
mature           <- floor(stand_st$MAT_TPA)
overmature       <- floor(stand_st$OVM_TPA)

# Top 3 Understory Species
under_species_1 <- NA
under_species_2 <- NA
under_species_3 <- NA

# Top 3 Ground Species
ground_species_1 <- NA
ground_species_2 <- NA
ground_species_3 <- NA

# Top 5 Overstory Species
o1_usda_code  <- species_sort[1,]$TR_SP
o1_avg_tpa    <- floor(species_sort[1,]$AV_TPA)
o1_avg_ba     <- floor(species_sort[1,]$AV_BA)
o1_qm_dbh     <- paste0(floor(species_sort[1,]$QM_DBH), '"')
o1_target_tpa <- ""                         
o1_target_ba  <- ""
o2_usda_code  <- species_sort[2,]$TR_SP
o2_avg_tpa    <- floor(species_sort[2,]$AV_TPA)
o2_avg_ba     <- floor(species_sort[2,]$AV_BA)
o2_qm_dbh     <- paste0(floor(species_sort[2,]$QM_DBH), '"')
o2_target_tpa <- ""
o2_target_ba  <- ""
o3_usda_code  <- species_sort[3,]$TR_SP
o3_avg_tpa    <- floor(species_sort[3,]$AV_TPA)
o3_avg_ba     <- floor(species_sort[3,]$AV_BA)
o3_qm_dbh     <- paste0(floor(species_sort[3,]$QM_DBH), '"')
o3_target_tpa <- ""
o3_target_ba  <- ""
o4_usda_code  <- species_sort[4,]$TR_SP
o4_avg_tpa    <- floor(species_sort[4,]$AV_TPA)
o4_avg_ba     <- floor(species_sort[4,]$AV_BA)
o4_qm_dbh     <- paste0(floor(species_sort[4,]$QM_DBH), '"')
o4_target_tpa <- ""
o4_target_ba  <- ""
o5_usda_code  <- species_sort[5,]$TR_SP
o5_avg_tpa    <- floor(species_sort[5,]$AV_TPA)
o5_avg_ba     <- floor(species_sort[5,]$AV_BA)
o5_qm_dbh     <- paste0(floor(species_sort[5,]$QM_DBH),'"')
o5_target_tpa <- ""
o5_target_ba  <- ""
```

<!--
## Stand ID
-->

::::: {#collector .grid-5w-1h }
::: {.var-name}
Forester
:::
::: {.empty-box}
`r forester`
:::
::: {.var-name}
Date
:::
::: {.empty-box}
`r date`
:::
:::::

::::: {#stand_id_1 .grid-5w-2h}
::: {.var-name}
FMG Pool
:::
::: {.var-value}
`r pool`
:::
::: {.var-name}
FMG Compartment
:::
::: {.var-value}
`r compartment`
:::
::: {.var-name}
FMG Unit
:::
::: {.var-value}
`r unit`
:::
::: {.var-name}
FMG Site 
:::
::: {.var-value}
`r site`
:::
::: {.var-name}
FMG Stand 
:::
::: {.var-value}
`r stand`
:::
:::::

::::: {#stand_id_2 .grid-5w-2h}
::: {.var-name}
\# of Plots
:::
::: {.var-value}
`r num_plots`
:::
::: {.var-name}
\# Age Plots
:::
::: {.var-value}
`r num_age_plots`
:::
::: {.var-name}
Walk Acreage
:::
::: {.var-value}
`r walk_acres`
:::
::: {.var-name}
Inventory Year
:::
::: {.var-value}
`r inventory_year`
:::
::: {.var-name}
Dominant Soil Type
:::
::: {.var-value}
`r dom_soil_type`
:::
:::::



## Stand Summary Data

::::: {#stand-summary-data .grid-6w-6h}
::: {.var-name}
Trees per Acre
:::
::: {.var-value}
`r tpa`
:::
::: {.var-name}
Hard Mast TPA
:::
::: {.var-value}
`r hard_mast_tpa`
:::
::: {.var-name}
Stand Age
:::
::: {.var-value}
`r stand_age`
:::
::: {.var-name}
Basal Area
:::
::: {.var-value}
`r basal_area`
:::
::: {.var-name}
Hard Mast BA
:::
::: {.var-value}
`r hard_mast_ba`
:::
::: {.var-name}
Hard Mast Age
:::
::: {.var-value}
`r hard_mast_age`
:::
::: {.var-name}
QM DBH
:::
::: {.var-value}
`r qm_dbh`
:::
::: {.var-name}
Hard Mast QM DBH
:::
::: {.var-value}
`r hard_mast_qm_dbh`
:::
::: {.var-name}
Growth
:::
::: {.var-value}
`r growth`
:::
::: {.var-name}
Stocking
:::
::: {.var-value}
`r stocking`
:::
::: {.var-name}
Hard Mast Stocking
:::
::: {.var-value}
`r hard_mast_stock`
:::
::: {.var-name}
Stand Health
:::
::: {.var-value}
`r stand_health`
:::
::: {.var-name}
Canopy Height
:::
::: {.var-value}
`r canopy_height`
:::
::: {.var-name}
Understory Height
:::
::: {.var-value}
`r under_height`
:::
::: {.var-name}
Species Richness
:::
::: {.var-value}
`r species_rich`
:::
::: {.var-name}
Canopy Closure
::: 
::: {.var-value}
`r canopy_closure`
:::
::: {.var-name}
Snag TPA
:::
::: {.var-value}
`r snag_tpa`
:::
::: {.var-name}
Regeneration Rate
:::
::: {.var-value}
`r regen_rate`
:::
:::::


<!--
## Section 3
-->

:::::::::::: {#section-3 .group-3-horz}
:::::::: {.section-box}
### Size Class Distribution (TPA)

::::: {.grid-2w-4h}
::: {.var-name}
Polesize (8"-12")
:::
::: {.var-value}
`r polesize`
:::
::: {.var-name}
Sawtimber (12"-18")
:::
::: {.var-value}
`r sawtimber`
:::
::: {.var-name}
Mature (18"-24")
:::
::: {.var-value}
`r mature`
:::
::: {.var-name}
Overmature (24"+)
:::
::: {.var-value}
`r overmature`
:::
:::::
::::::::
:::::::: {.section-box}
### Top 3 Understory Species

::::: {.grid-2w-4h}
::: {.var-name}
Species 1
:::
::: {.var-value}
`r under_species_1`
:::
::: {.var-name}
Species 2
:::
::: {.var-value}
`r under_species_2`
:::
::: {.var-name}
Species 3
:::
::: {.var-value}
`r under_species_3`
:::
:::::
::::::::
:::::::: {.section-box}
### Top 3 Ground Species

::::: {.grid-2w-4h}
::: {.var-name}
Species 1
:::
::: {.var-value}
`r ground_species_1`
:::
::: {.var-name}
Species 2
:::
::: {.var-value}
`r ground_species_2`
:::
::: {.var-name}
Species 3
:::
::: {.var-value}
`r ground_species_3`
:::
:::::
::::::::
::::::::::::



<!--
## Section 4
-->

:::::::::::: {#section-4 .group-5-vert}
### Top 5 Overstory Species

<!-- Overstory Species 1 -->
:::::::: {.section-box}
::::: {.grid-6w-2h}
::: {.var-name}
USDA Code
:::
::: {.var-value}
`r o1_usda_code`
:::
::: {.var-name}
Avg. TPA
:::
::: {.var-value}
`r o1_avg_tpa`
:::
::: {.var-name}
Avg. BA
:::
::: {.var-value}
`r o1_avg_ba`
:::
::: {.var-name}
QM DBH
:::
::: {.var-value}
`r o1_qm_dbh`
:::
::: {.var-name}
Target TPA
:::
::: {.var-value}
`r o1_target_tpa`
:::
::: {.var-name}
Target BA
:::
::: {.var-value}
`r o1_target_ba`
:::
:::::
::::::::

<!-- Overstory Species 2 -->
:::::::: {.section-box}
::::: {.grid-6w-2h}
::: {.var-name}
USDA Code
:::
::: {.var-value}
`r o2_usda_code`
:::
::: {.var-name}
Avg. TPA
:::
::: {.var-value}
`r o2_avg_tpa`
:::
::: {.var-name}
Avg. BA
:::
::: {.var-value}
`r o2_avg_ba`
:::
::: {.var-name}
QM DBH
:::
::: {.var-value}
`r o2_qm_dbh`
:::
::: {.var-name}
Target TPA
:::
::: {.var-value}
`r o2_target_tpa`
:::
::: {.var-name}
Target BA
:::
::: {.var-value}
`r o2_target_ba`
:::
:::::
::::::::

<!-- Overstory Species 3 -->
:::::::: {.section-box}
::::: {.grid-6w-2h}
::: {.var-name}
USDA Code
:::
::: {.var-value}
`r o3_usda_code`
:::
::: {.var-name}
Avg. TPA
:::
::: {.var-value}
`r o3_avg_tpa`
:::
::: {.var-name}
Avg. BA
:::
::: {.var-value}
`r o3_avg_ba`
:::
::: {.var-name}
QM DBH
:::
::: {.var-value}
`r o3_qm_dbh`
:::
::: {.var-name}
Target TPA
:::
::: {.var-value}
`r o3_target_tpa`
:::
::: {.var-name}
Target BA
:::
::: {.var-value}
`r o3_target_ba`
:::
:::::
::::::::

<!-- Overstory Species 4 -->
:::::::: {.section-box}
::::: {.grid-6w-2h}
::: {.var-name}
USDA Code
:::
::: {.var-value}
`r o4_usda_code`
:::
::: {.var-name}
Avg. TPA
:::
::: {.var-value}
`r o4_avg_tpa`
:::
::: {.var-name}
Avg. BA
:::
::: {.var-value}
`r o4_avg_ba`
:::
::: {.var-name}
QM DBH
:::
::: {.var-value}
`r o4_qm_dbh`
:::
::: {.var-name}
Target TPA
:::
::: {.var-value}
`r o4_target_tpa`
:::
::: {.var-name}
Target BA
:::
::: {.var-value}
`r o4_target_ba`
:::
:::::
::::::::

<!-- Overstory Species 5 -->
:::::::: {.section-box}
::::: {.grid-6w-2h}
::: {.var-name}
USDA Code
:::
::: {.var-value}
`r o5_usda_code`
:::
::: {.var-name}
Avg. TPA
:::
::: {.var-value}
`r o5_avg_tpa`
:::
::: {.var-name}
Avg. BA
:::
::: {.var-value}
`r o5_avg_ba`
:::
::: {.var-name}
QM DBH
:::
::: {.var-value}
`r o5_qm_dbh`
:::
::: {.var-name}
Target TPA
:::
::: {.var-value}
`r o5_target_tpa`
:::
::: {.var-name}
Target BA
:::
::: {.var-value}
`r o5_target_ba`
:::
:::::
::::::::

::::::::::::

report version: `r report_version`